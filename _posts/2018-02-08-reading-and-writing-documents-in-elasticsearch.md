---
layout: post
title: "在 Elasticsearch 中读写文档"
date: "2018-02-08"
description: "在 Elasticsearch 中读写文档"
tag: [elasticsearch]
---

### 介绍
在 Elasticsearch 中的索引都会被 [分片](https://www.elastic.co/guide/en/elasticsearch/reference/current/_basic_concepts.html#getting-started-shards-and-replicas), 并且每个分片都有多个拷贝; 这些副本被称为一个副本组, 当有文档被添加或移除时需要保持同步; 如果同步失败, 从一个拷贝中读取的将会与另一个拷贝中读取的文档不同; 保持分片拷贝同步以及从中读取的处理我们称之为数据副本模型  
Elasticsearch 的数据副本模型基于主从模型的, 在微软研究的 [PacificA](https://www.microsoft.com/en-us/research/publication/pacifica-replication-in-log-based-distributed-storage-systems/) 论文中有很好的描述; 此模型基于从作为主分片的副本组, 其他拷贝被称为副本分片; 主分片作为所有所有索引操作的主入点, 它负责检验并确保操作是正确的; 一旦索引操作被主分片接受, 主分片要负责将操作备份到其他副本  
本节的主要给出 Elasticsearch 副本模型的一个高层概览, 并且对于读写操作的各种交互讨论其含义

### 基础写模型
典型的基于文档 ID, 在 Elasticsearch 中每个索引操作会使用 [路由](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-routing) 首先被解析到一个副本组; 一旦副本组被确定, 操作别内部转发到所属组的当前主分片; 主分片负责检验操作转发操作到其他副本; 因为副本可能是离线的, 主分片不会别要求备份到所有副本; 此外, Elasticsearch 会维护一个应该接受操作的分片拷贝列表; 这个列表被称为同步中的副本, 并且由主节点维护;  顾名思义, 这些 "好" 的分片副本会保证处理所有已向用户确认的索引和删除操作; 主分片负责维护不变性, 因此需要向这个集合中的每个分片复制所有的操作  
主分片遵循以下的基本流程:
- 校验到来的操作并在结构无效的情况下拒绝 (例如: 期待一个数字的 object 域)
- 在本地执行操作, 索引或删除相关文档; 这会校验字段的值并在需要的情况下拒绝 (例如: 在 Lucene 中索引时关键字的值太长)
- 转发操作到当前同步副本集合中的每个副本, 如果这个有多个副本, 会并行执行
- 一旦所有的副本都成功的执行了操作并且响应到主分片, 主分片将成功完成的请求通知给客户端
#### 失败处理
在索引的过程中许多事都可能出错, 如硬盘奔溃, 节点失联, 或者一些错误配置造成在副本上的操作失败, 尽管在主分片上是成功的; 这是不常见的但是主分片不得不响应  
当主分片自己失败的情况下, 拥有主分片的节点会发失败的消息给主节点; 索引操作将会等待 ([默认](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html#dynamic-index-settings)
最多一分钟) 主节点从副本中选举一个新的主分片, 操作将会被转发到新的主分片进行处理; 注意, 主节点会监视节点的健康并且可能会决定主动降级主分片, 这通常发生在拥有主分片的节点因为网络问题被集群孤立, 详见 [这里] (https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-replication.html#demoted-primary)  
一旦操作在主分片被成功的执行, 主分片需要处理在副本分片上执行操作时的潜在失败; 这可能是由于副本上的失败或是由于网络问题阻止操作到达副本 (或副本不能响应) 造成的; 以上所有都会导致相同的结果, 同步副本集的部分副本丢失这个即将被确认的操作; 为了避免违反一致性, 主分片将会发送消息到主节点, 要求将问题分片移出同步副本集; 一旦分片移出被主节点确认, 主分片就会确认这个操作; 主节点会命令另一个节点开始建立一个新的分片副本为了将系统恢复到健康状态  
当转发操作到副本时, 当主分片将使用副本去检验它是否仍是活跃的主分片; 如果主分片由于网络分区 (或长 GC) 被孤立, 在它意识到被孤立前它仍能继续处理到来的索引操作; 来自于旧主分片的操作将会被副本拒绝; 因为不再是主分片了, 当旧主分片接收到副本拒绝请求的响应, 它或联系主节点然后会意识到自己已经被代替了; 操作将会被路由到新的主分片
#### 如果没有副本将会发生什么
 这种场景会由于索引配置或者仅因为所有的分片都失败而发生; 在这种情况下, 主分片将处理操作而不会有任何额外的检验, 这看起来似乎是有问题的; 另一方面, 主分片它自己不能失败其他分片, 只有请求主节点代表它这样做; 这意味着主节点知道主分片是唯一良好的节点; 因此, 我们能保证主节点将会不推举任何其他 (过时的) 分片副本作为新的主分片, 并且任何索引到主分片的操作都不会丢失; 当然, 因为在这种情况在我们运行着单一的数据副本, 物理硬件问题将会造成数据丢失; 一些减缓操作见 [Wait For Active Shards](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-wait-for-active-shards)

 ### 基础读模型
在 Elasticsearch 中, 读请求可以使his轻量级的根据 ID 查找或者是消耗大量 CPU 的复杂聚合的重量级搜索请求; 主备模型的好处之一就是它保留了所有分片副本统一 (除了在极速操作中); 这样, 单个同步副本就足以服务读请求  
当读请求被一个节点接受, 这个节点负责将请求转发给拥有相关分片的节点并收集响应, 再响应到客户端; 对于此请求我们成这个节点为协调节点, 基本流程如下:
- 决定读请求到相关分片, 因为大多数搜索将会被发送给一个或多个索引, 需要从多个分片中去读, 每个代表不同的数据子集
- 选择每个相关分片的一个活跃副本, 从分片副本组中; 这可以使主分片也可以使副本分片; 默认的, Elasticsearch 将会简单的在分片副本中轮询
- 发送分片级别的读请求到选择的副本
- 联合结果和响应; 注意, 在通过 ID 查找的场景中, 仅只有一个分片相关, 这一步将会被跳过
#### 失败处理
对一个读请求的一个分片响应失败, 协调节将会选择来自相同副本组的另一个副本, 并发送分片几倍的搜索请求到代替的副本; 多次失败会导致没有可用的分片副本; 在一些情况下, 例如 `_search`, Elasticsearch 更倾向于快速响应, 即使只有部分结果, 而不是等待问题被解决 (部分结果意味着 `_shards` 头响应)

### 一些简单的示意
每个基础的流都决定着 Elasticsearch 作为一个系统对于读写是如何表现的; 更多的, 因为读写请求可以被并发执行, 所以有两个基础流与之对应; 这有一些内在的含义:
- 有效读
在正常操作下, 每个读请求对于每个相关的副本组只执行一次; 在失败的条件下, 同一个分片的多个副本会被执行相同的搜索
- 读非确认
因为主分片首先在本地索引然后在请求副本, 对于一个并发读有可能在变化被确认前就看到变化
- 默认两个副本
即使值维护两个数据副本此模型也可容错; 这与基于集群系统相比, 集群系统容错的最少副本数是 3

### 失败
在失败时, 以下情况是可能的:
- 单个分片拖慢索引
因为主分片在操作期间等待同步副本集中的所有副本响应, 单个慢分片会拖慢整个副本组; 这是我们为之前提到的有效读付出的代价; 当搜索不幸路由到此吗慢分片也会拖慢搜索
- 脏读
一个孤立的主分片可以暴露出不会被确认的写操作; 这是因为一个孤立的主分片仅在它发送请求到它的副本或当连接到主节点时才会意识到自己是孤立的; 在此刻, 操作已经被索引到主分片并且能够被并发读; Elasticsearch 通过每秒去 ping 主节点降低风险, 并且拒绝无主节点知晓的索引操作

### 冰山一角
本文档呈现了一个高视角的关于 Elasticsearch 如果处理数据的概览; 当然在这之下还有很多需要了解; 如主分片确认, 集群状态公布, 主节点选举等在维持系统正确运行中扮演着重要的角色; 此文档并没有覆盖已知的和重要的 bugs (包括关闭的和打开的); 我们意识到 [Github](https://github.com/elastic/elasticsearch/issues?q=label%3Aresiliency) 很难跟得上; 为了帮助用户保持前沿, 我们在我们的网站维护了一个专门的 [弹性页面](https://www.elastic.co/guide/en/elasticsearch/resiliency/current/index.html); 强烈建议阅读它

>**参考:**
[Reading and Writing documents](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-replication.html#_a_few_simple_implications)
